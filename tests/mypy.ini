# Mypy configuration for test code
# Location: tests/mypy.ini
# Invoked by: cd tests && mypy . (from scripts/lint.sh)
#
# ============================================================================
# ARCHITECTURAL PHILOSOPHY
# ============================================================================
#
# This configuration maintains type safety while acknowledging that tests
# optimize for clarity and comprehension over exhaustive type annotations.
#
# NEVER RELAX (even in tests):
# - strict_equality: False == None bugs are bugs everywhere
# - warn_redundant_casts: Redundant casts indicate type errors
# - warn_no_return: Missing returns are logic errors
# - warn_unreachable: Dead code is dead code
#
# PRAGMATIC RELAXATIONS (test-specific):
# - disallow_untyped_defs: Test fixtures don't need full annotations
# - warn_return_any: Test helpers may return Any for flexibility
# - disallow_any_generics: Test data (List vs List[str]) can be lenient
#
# RATIONALE:
# Tests are executable specifications. Type safety prevents "worked in tests,
# broke in production" errors. But tests also need to be readable, and DSL
# mimicry (FTL functions) may not map to Python's type system perfectly.
#
# ============================================================================

[mypy]
# Python version (must match pyproject.toml: requires-python = ">=3.13")
python_version = 3.13

# ============================================================================
# TYPE CHECKING STRICTNESS
# ============================================================================

# Overall strictness: Pragmatic, not pedantic
strict = false

# Type inference and checking
# Test fixtures may return Any (e.g., Mock objects)
warn_return_any = false
# DO check types when provided
check_untyped_defs = true
# NEVER relax - prevents None bugs
no_implicit_optional = true

# Code quality warnings (KEEP THESE - prevent actual bugs)
# Redundant cast = type error
warn_redundant_casts = true
# Stale type ignores accumulate
warn_unused_ignores = true
# Missing return = logic error
warn_no_return = true
# Dead code should be removed
warn_unreachable = true

# Equality checking (NEVER relax)
# False == None, 0 == [], etc. are bugs
strict_equality = true

# ============================================================================
# ANNOTATION REQUIREMENTS (relaxed for test convenience)
# ============================================================================

# Allow test helpers without full type annotations
# Example: def UPPER(value) -> str:  # 'value' parameter has no type
disallow_untyped_defs = false

# Allow generic types without parameters
# Example: List instead of List[str] in test setup data
disallow_any_generics = false

# Allow untyped function calls (test helpers, mocks)
disallow_untyped_calls = false

# Allow untyped decorators (pytest fixtures, hypothesis)
disallow_untyped_decorators = false

# ============================================================================
# IMPORT HANDLING
# ============================================================================

# Follow imports normally (don't skip test dependencies)
follow_imports = normal

# All test dependencies should have types (hypothesis, pytest have stubs)
ignore_missing_imports = false

# Namespace packages (not used in this project)
namespace_packages = false

# ============================================================================
# ERROR REPORTING
# ============================================================================

# Show error codes for easy reference (e.g., [union-attr])
show_error_codes = true

# Pretty output with colors
pretty = true
color_output = true

# Show summary of errors by type
error_summary = true

# Show absolute paths (easier for IDE integration)
show_absolute_path = false

# ============================================================================
# INCREMENTAL CHECKING
# ============================================================================

# Enable incremental mode for faster repeat runs
incremental = true
cache_dir = .mypy_cache

# ============================================================================
# PER-MODULE OVERRIDES
# ============================================================================

# Hypothesis strategies generate complex composite types
[mypy-tests.strategies]
disallow_any_generics = false
disallow_untyped_defs = false

# Parsing property tests use complex Hypothesis character categories
# Type hints in Hypothesis strategies are complex and may not align perfectly with mypy
[mypy-tests.test_parsing_currency_property]
disable_error_code = arg-type

[mypy-tests.test_parsing_dates_property]
disable_error_code = arg-type
warn_unused_ignores = false

[mypy-tests.test_parsing_numbers_property]
disable_error_code = arg-type

# Fuzz version of numbers property test (lives in tests/fuzz/ package)
[mypy-tests.fuzz.test_parsing_numbers_property]
disable_error_code = arg-type

# Breaking change tests intentionally import symbols that don't exist
# to verify ImportError is raised correctly
[mypy-tests.test_parsing_babel_compat]
disable_error_code = attr-defined

# ============================================================================
# NOTES ON REMAINING ERRORS
# ============================================================================
#
# After this configuration, remaining mypy errors indicate REAL issues:
#
# 1. union-attr errors (77 total):
#    - Cause: Accessing Entry union (Message | Term | Comment | Junk) without
#      isinstance() check
#    - Fix: Add isinstance() checks before attribute access
#    - Example:
#        entry = resource.entries[0]
#        assert isinstance(entry, Message)
#        assert entry.id.name == "hello"  # Now type-safe
#
# 2. no-untyped-def errors (2 total):
#    - Cause: Test helper functions missing return type
#    - Fix: Add return type annotation
#    - Example: def UPPER(value) -> str:
#
# These are intentional - mypy should catch these to ensure test correctness.
#
# ============================================================================
